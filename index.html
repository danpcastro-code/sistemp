
import React, { useState, useMemo } from 'react';
import { Vacancy, ConvokedPerson, Occupation, CompetitionType, ContractStatus } from '../types';
import { calculateDaysUsed, maskCPF } from '../utils';
import { 
  FileText, 
  Download, 
  Search, 
  Filter, 
  PieChart as PieIcon, 
  Users, 
  Calendar,
  Building2,
  AlertTriangle,
  Briefcase,
  Award,
  RefreshCw
} from 'lucide-react';
import { PieChart, Pie, Cell, ResponsiveContainer, Tooltip, Legend } from 'recharts';
import { format } from 'date-fns';

interface ReportsViewProps {
  vacancies: Vacancy[];
  convocations: ConvokedPerson[];
}

const COLORS = ['#3b82f6', '#f59e0b', '#a855f7', '#10b981'];

const ReportsView: React.FC<ReportsViewProps> = ({ vacancies, convocations }) => {
  const [selectedNotice, setSelectedNotice] = useState<string>('all');
  const [selectedCargo, setSelectedCargo] = useState<string>('all');
  const [selectedCompetition, setSelectedCompetition] = useState<string>('all');

  const availableNotices = useMemo(() => {
    const notices = new Set<string>();
    vacancies.forEach(v => notices.add(v.publicNotice));
    return Array.from(notices).sort();
  }, [vacancies]);

  const availableCargos = useMemo(() => {
    const cargos = new Set<string>();
    const source = selectedNotice === 'all' ? vacancies : vacancies.filter(v => v.publicNotice === selectedNotice);
    source.forEach(v => cargos.add(v.type));
    return Array.from(cargos).sort();
  }, [vacancies, selectedNotice]);

  const reportData = useMemo(() => {
    const data: { 
      vacancy: Vacancy; 
      occupation: Occupation; 
      person?: ConvokedPerson;
      isReplacement: boolean;
      prevDaysConsumed: number;
    }[] = [];
    
    vacancies.forEach(v => {
      const matchNotice = selectedNotice === 'all' || v.publicNotice === selectedNotice;
      const matchCargo = selectedCargo === 'all' || v.type === selectedCargo;
      
      if (matchNotice && matchCargo) {
        v.occupations.forEach(occ => {
          const person = convocations.find(p => p.id === occ.personId);
          const personComp = person?.competition || CompetitionType.AC;
          const matchComp = selectedCompetition === 'all' || personComp === selectedCompetition;
          
          if (matchComp) {
            const previousOccupants = v.occupations.filter(
              o => o.slotIndex === occ.slotIndex && o.order < occ.order
            );
            
            data.push({ 
              vacancy: v, 
              occupation: occ, 
              person,
              isReplacement: previousOccupants.length > 0,
              prevDaysConsumed: calculateDaysUsed(previousOccupants)
            });
          }
        });
      }
    });
    return data.sort((a, b) => b.occupation.startDate.localeCompare(a.occupation.startDate));
  }, [selectedNotice, selectedCargo, selectedCompetition, vacancies, convocations]);

  const statsByCargo = useMemo(() => {
    const cargoMap: Record<string, { total: number; occupied: number }> = {};
    const sourceVacancies = selectedNotice === 'all' ? vacancies : vacancies.filter(v => v.publicNotice === selectedNotice);
    sourceVacancies.forEach(v => {
      if (!cargoMap[v.type]) cargoMap[v.type] = { total: 0, occupied: 0 };
      cargoMap[v.type].total += v.initialQuantity;
      cargoMap[v.type].occupied += v.occupations.filter(o => o.status === ContractStatus.ACTIVE).length;
    });
    return Object.entries(cargoMap).map(([name, data]) => ({
      name,
      ...data,
      percentage: (data.occupied / data.total) * 100
    })).sort((a, b) => b.percentage - a.percentage);
  }, [vacancies, selectedNotice]);

  const statsByCompetition = useMemo(() => {
    const compMap: Record<string, number> = {
      [CompetitionType.AC]: 0,
      [CompetitionType.PPP]: 0,
      [CompetitionType.PCD]: 0
    };
    const activeOccupations = reportData.filter(d => d.occupation.status === ContractStatus.ACTIVE);
    const totalActive = activeOccupations.length || 1;
    activeOccupations.forEach(d => {
      const type = d.person?.competition || CompetitionType.AC;
      compMap[type] = (compMap[type] || 0) + 1;
    });
    return Object.entries(compMap).map(([name, count]) => ({
      name,
      count,
      percentage: (count / totalActive) * 100
    }));
  }, [reportData]);

  const generalStats = useMemo(() => {
    const baseVacancies = vacancies.filter(v => {
        const matchNotice = selectedNotice === 'all' || v.publicNotice === selectedNotice;
        const matchCargo = selectedCargo === 'all' || v.type === selectedCargo;
        return matchNotice && matchCargo;
    });
    const totalSlots = baseVacancies.reduce((acc, v) => acc + v.initialQuantity, 0);
    const activeInReport = reportData.filter(d => d.occupation.status === ContractStatus.ACTIVE).length;
    const replacementsInReport = reportData.filter(d => d.isReplacement).length;
    const chartData = statsByCompetition.map(s => ({ name: s.name, value: s.count }));
    return { totalSlots, activeOccupations: activeInReport, vacantSlots: Math.max(0, totalSlots - activeInReport), replacementsCount: replacementsInReport, chartData };
  }, [vacancies, reportData, statsByCompetition, selectedNotice, selectedCargo]);

  const exportToCSV = () => {
    const headers = [
      "Edital", "Vaga/Codigo", "Cargo", "Posto", "Provimento", "Consumo Prev.", 
      "Contratado", "CPF", "Concorrencia", "Inicio", "Fim", "Status"
    ];
    const rows = reportData.map(d => [
      d.vacancy.publicNotice, d.vacancy.code, d.vacancy.type, d.occupation.slotIndex,
      d.isReplacement ? "SUBSTITUI√á√ÉO (REUSO)" : "ORIGINAL",
      d.prevDaysConsumed > 0 ? `${d.prevDaysConsumed} dias` : "0",
      d.occupation.contractedName, maskCPF(d.person?.cpf || ''), d.person?.competition || 'AC',
      d.occupation.startDate, d.occupation.endDate, d.occupation.status
    ]);
    const csvContent = ["sep=,", headers.join(","), ...rows.map(row => row.join(","))].join("\n");
    const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.setAttribute("download", `relatorio_auditavel_${format(new Date(), 'yyyyMMdd')}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  return (
    <div className="space-y-6 animate-in fade-in duration-500">
      <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col gap-6">
        <div className="flex items-center justify-between">
          <div className="flex items-center space-x-4">
            <div className="p-3 bg-blue-50 text-blue-600 rounded-xl">
              <FileText size={24} />
            </div>
            <div>
              <h2 className="text-xl font-bold text-slate-800">Relat√≥rio Audit√°vel de Vagas</h2>
              <p className="text-sm text-slate-500 font-medium">Controle de reuso de postos e substitui√ß√µes tempor√°rias.</p>
            </div>
          </div>
          <button onClick={exportToCSV} className="hidden md:flex items-center space-x-2 px-6 py-2.5 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-800 transition-all shadow-lg active:scale-95">
            <Download size={18} /> <span>Extrair CSV</span>
          </button>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div className="relative">
            <Filter className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={16} />
            <select value={selectedNotice} onChange={(e) => { setSelectedNotice(e.target.value); setSelectedCargo('all'); }} className="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-xs font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500 appearance-none">
              <option value="all">TODOS OS EDITAIS</option>
              {availableNotices.map(n => <option key={n} value={n}>{n}</option>)}
            </select>
          </div>
          <div className="relative">
            <Briefcase className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={16} />
            <select value={selectedCargo} onChange={(e) => setSelectedCargo(e.target.value)} className="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-xs font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500 appearance-none">
              <option value="all">TODOS OS CARGOS</option>
              {availableCargos.map(c => <option key={c} value={c}>{c}</option>)}
            </select>
          </div>
          <div className="relative">
            <Award className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={16} />
            <select value={selectedCompetition} onChange={(e) => setSelectedCompetition(e.target.value)} className="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-xs font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500 appearance-none">
              <option value="all">TODAS AS CONCORR√äNCIAS</option>
              <option value={CompetitionType.AC}>AMPLA CONCORR√äNCIA</option>
              <option value={CompetitionType.PPP}>COTAS (PPP)</option>
              <option value={CompetitionType.PCD}>PCD</option>
            </select>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div className="lg:col-span-2 space-y-6">
          <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div className="p-5 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
              <h3 className="text-sm font-bold text-slate-700 uppercase tracking-wider flex items-center">
                <Search size={16} className="mr-2" /> Hist√≥rico de Provimentos
              </h3>
              <div className="flex items-center space-x-3">
                 <span className="text-[10px] font-black bg-blue-100 text-blue-600 border border-blue-200 px-2 py-0.5 rounded uppercase">
                    {generalStats.replacementsCount} Substitui√ß√µes
                 </span>
                 <span className="text-[10px] font-black bg-white border px-2 py-0.5 rounded text-slate-400">
                    {reportData.length} Contratos
                 </span>
              </div>
            </div>
            <div className="overflow-x-auto max-h-[600px] overflow-y-auto custom-scrollbar">
              <table className="w-full text-left">
                <thead className="sticky top-0 bg-white shadow-sm z-10">
                  <tr className="text-slate-500 text-[9px] uppercase tracking-widest font-bold border-b border-slate-100">
                    <th className="px-6 py-4">Candidato / Provimento</th>
                    <th className="px-6 py-4">Vaga / Posto</th>
                    <th className="px-6 py-4">Per√≠odo / Saldo</th>
                    <th className="px-6 py-4 text-right">Status</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-slate-50">
                  {reportData.map((d, i) => (
                    <tr key={i} className="hover:bg-slate-50 transition-colors text-sm">
                      <td className="px-6 py-4">
                        <div className="flex flex-col">
                           <p className="font-bold text-slate-800 leading-tight">{d.occupation.contractedName}</p>
                           <div className="flex items-center mt-1 space-x-2">
                               <span className={`text-[8px] font-black px-1.5 py-0.5 rounded border uppercase ${d.isReplacement ? 'bg-amber-50 text-amber-600 border-amber-100' : 'bg-slate-50 text-slate-400 border-slate-200'}`}>
                                 {d.isReplacement ? 'üîÑ Substitui√ß√£o (Reuso)' : 'Original'}
                               </span>
                               <span className="text-[9px] text-slate-400 font-bold uppercase">{maskCPF(d.person?.cpf || '')}</span>
                           </div>
                        </div>
                      </td>
                      <td className="px-6 py-4">
                        <p className="text-[10px] text-slate-400 font-bold uppercase leading-none mb-1">{d.vacancy.type}</p>
                        <span className="text-xs font-mono font-bold text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded border border-blue-100">
                          {d.vacancy.code} (Posto #{d.occupation.slotIndex})
                        </span>
                      </td>
                      <td className="px-6 py-4">
                        {/* Fix: Replaced parseISO with native Date parsing */}
                        <p className="text-xs font-medium text-slate-500">{format(new Date(d.occupation.startDate + 'T00:00:00'), 'dd/MM/yyyy')} a {format(new Date(d.occupation.endDate + 'T00:00:00'), 'dd/MM/yyyy')}</p>
                        {d.isReplacement && (
                            <p className="text-[9px] text-amber-600 font-black uppercase mt-1 flex items-center">
                                <RefreshCw size={10} className="mr-1" /> Contagem Continuada: {d.prevDaysConsumed}d Pr√©vios
                            </p>
                        )}
                      </td>
                      <td className="px-6 py-4 text-right">
                        <span className={`text-[9px] font-black uppercase px-2 py-0.5 rounded border ${d.occupation.status === ContractStatus.ACTIVE ? 'bg-green-50 text-green-700 border-green-100' : 'bg-red-50 text-red-700 border-red-100'}`}>
                          {d.occupation.status}
                        </span>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div className="space-y-6">
          <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <h3 className="text-sm font-bold text-slate-700 uppercase tracking-wider mb-6 flex items-center">
              <Award size={16} className="mr-2 text-indigo-500" /> Mix de Concorr√™ncia
            </h3>
            <div className="space-y-4">
              {statsByCompetition.map((comp, idx) => (
                <div key={idx} className={`p-4 rounded-xl border transition-all ${selectedCompetition === comp.name ? 'border-indigo-500 bg-indigo-50' : 'border-slate-100 bg-slate-50/30'}`}>
                  <div className="flex justify-between items-end mb-2">
                    <p className="text-xs font-bold text-slate-800">{comp.name}</p>
                    <div className="text-right">
                      <p className="text-lg font-black text-slate-800 leading-none">{comp.count}</p>
                      <p className="text-[10px] font-bold text-indigo-600 uppercase">{Math.round(comp.percentage)}%</p>
                    </div>
                  </div>
                  <div className="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                    <div className="h-full bg-indigo-500 transition-all duration-700" style={{ width: `${comp.percentage}%` }} />
                  </div>
                </div>
              ))}
            </div>
          </div>
          <div className="bg-indigo-600 p-6 rounded-2xl shadow-lg text-white">
             <div className="flex items-center space-x-3 mb-4">
                <RefreshCw size={24} className="text-indigo-200" />
                <h3 className="font-bold text-sm uppercase tracking-widest">L√≥gica de Reuso</h3>
             </div>
             <p className="text-xs text-indigo-100 leading-relaxed font-medium">Vagas ocupadas por novo contratado vigoram apenas pelo tempo remanescente. O sistema bloqueia provimentos que excedam o saldo hist√≥rico do posto individual.</p>
             <div className="mt-6 pt-4 border-t border-indigo-500 flex justify-between items-center">
                <span className="text-[10px] font-black uppercase">Substitui√ß√µes no filtro:</span>
                <span className="text-xl font-black">{generalStats.replacementsCount}</span>
             </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default ReportsView;

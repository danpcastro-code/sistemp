<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SisTemp - Controle de Vagas e Contratos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; letter-spacing: -0.01em; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        @keyframes pulse-ring {
            0% { transform: scale(.33); opacity: 1; }
            80%, 100% { opacity: 0; }
        }
        .pulse-ring { position: relative; display: flex; align-items: center; justify-content: center; }
        .pulse-ring::before {
            content: '';
            position: absolute;
            width: 300%;
            height: 300%;
            background-color: #22c55e;
            border-radius: 50%;
            animation: pulse-ring 2s cubic-bezier(0.455, 0.03, 0.515, 0.955) infinite;
        }
        .glass-panel { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
    </style>
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom": "https://esm.sh/react-dom@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.284.0",
    "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2",
    "date-fns": "https://esm.sh/date-fns@2.30.0",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "react/": "https://esm.sh/react@^19.2.4/",
    "recharts": "https://esm.sh/recharts@^3.7.0"
  }
}
</script>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useCallback, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            LayoutDashboard, Users, Settings, LogOut, ShieldCheck, Zap, X, Building2, History, AlertCircle, 
            Plus, Search, ChevronRight, Award, FileText, Bell, Clock, Database, Globe, Key, Terminal, Download, 
            CheckCircle2, Info, UserPlus, FileSpreadsheet, UserX, CalendarClock, UserCheck, ArrowRight, RefreshCw,
            Layers, ShieldAlert, AlertTriangle, Mail, Calendar, Filter, Briefcase, Award as AwardIcon
        } from 'lucide-react';
        import { createClient } from '@supabase/supabase-js';
        import { differenceInDays, parseISO, addDays, format, addYears, isAfter, startOfDay } from 'date-fns';

        // --- CONSTANTS & MOCKS ---
        const INITIAL_PARAMETERS = [
            { id: 'p1', label: 'Art 2º, IV', days: 730, description: 'Professores Substitutos' },
            { id: 'p2', label: 'Art 2º, VI', days: 1460, description: 'Técnicos Especializados' }
        ];

        const INITIAL_VACANCIES = [
            { id: 'v1', code: 'VAG-2024-001', type: 'Professor Substituto', agency: 'UFRJ', status: 'Provida', initialQuantity: 3, occupations: [], publicNotice: 'Edital 01/2024', maxTermDays: 730 }
        ];

        // --- UTILS ---
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const maskCPF = (cpf) => cpf ? `***.${cpf.substring(4, 7)}.${cpf.substring(8, 11)}-**` : '';
        const calculateDaysUsed = (occupations) => occupations.reduce((acc, occ) => acc + Math.max(0, differenceInDays(parseISO(occ.endDate), parseISO(occ.startDate))), 0);
        
        const getWarningInfo = (occ) => {
            if (occ.status !== 'Ativo') return { isWarning: false };
            const today = startOfDay(new Date());
            const daysToFinal = differenceInDays(parseISO(occ.projectedFinalDate), today);
            if (daysToFinal <= 90) return { isWarning: true, label: 'Vencimento Próximo', daysLeft: daysToFinal, date: occ.projectedFinalDate, type: 'final' };
            return { isWarning: false };
        };

        const getVacancyStats = (v) => {
            const totalCapacity = v.maxTermDays * v.initialQuantity;
            const used = calculateDaysUsed(v.occupations);
            const activeSlots = new Set(v.occupations.filter(o => o.status === 'Ativo').map(o => o.slotIndex));
            return {
                daysRemainingTotal: Math.max(0, totalCapacity - used),
                percentageUsedTotal: (used / totalCapacity) * 100,
                currentlyActiveCount: activeSlots.size
            };
        };

        // --- COMPONENTS ---

        const LoginView = ({ onLogin }) => {
            const [u, setU] = useState('');
            const [p, setP] = useState('');
            return (
                <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
                    <div className="bg-white p-12 rounded-[3rem] shadow-2xl max-w-md w-full text-center">
                        <div className="inline-flex p-4 bg-blue-600 rounded-3xl mb-6 shadow-xl"><ShieldCheck size={48} className="text-white" /></div>
                        <h1 className="text-4xl font-black tracking-tighter mb-2">SisTemp</h1>
                        <p className="text-slate-400 text-[10px] font-black uppercase tracking-[0.2em] mb-10">Gestão de Vagas Temporárias</p>
                        <form onSubmit={e => { e.preventDefault(); if(u==='gestao'&&p==='123') onLogin({name: 'Gestor Administrativo'}); else alert('Erro!'); }} className="space-y-4">
                            <input value={u} onChange={e=>setU(e.target.value)} placeholder="Usuário (gestao)" className="w-full p-4 bg-slate-50 border rounded-2xl outline-none focus:ring-2 focus:ring-blue-500" />
                            <input value={p} onChange={e=>setP(e.target.value)} type="password" placeholder="Senha (123)" className="w-full p-4 bg-slate-50 border rounded-2xl outline-none focus:ring-2 focus:ring-blue-500" />
                            <button className="w-full py-5 bg-slate-900 text-white rounded-2xl font-black uppercase tracking-widest shadow-xl hover:bg-slate-800 transition-all">Entrar</button>
                        </form>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ vacancies }) => (
            <div className="space-y-8 animate-in fade-in duration-700">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div className="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm">
                        <p className="text-[10px] font-black text-slate-400 uppercase mb-2">Grupos de Vagas</p>
                        <p className="text-4xl font-black text-slate-800">{vacancies.length}</p>
                    </div>
                    <div className="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm">
                        <p className="text-[10px] font-black text-slate-400 uppercase mb-2">Postos Ativos</p>
                        <p className="text-4xl font-black text-green-600">{vacancies.reduce((acc, v) => acc + getVacancyStats(v).currentlyActiveCount, 0)}</p>
                    </div>
                    <div className="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm">
                        <p className="text-[10px] font-black text-slate-400 uppercase mb-2">Status Sistema</p>
                        <p className="text-4xl font-black text-blue-600 flex items-center">Ativo <Zap size={24} className="ml-2 fill-blue-600" /></p>
                    </div>
                </div>
                <div className="bg-white p-20 rounded-[4rem] border-2 border-dashed border-slate-100 flex flex-col items-center justify-center text-slate-300">
                    <LayoutDashboard size={80} className="mb-6 opacity-10" />
                    <h3 className="text-xl font-bold text-slate-400">Ambiente Operacional Pronto</h3>
                    <p className="italic text-sm mt-2">Clique em "Vagas" no menu lateral para iniciar a gestão.</p>
                </div>
            </div>
        );

        const SettingsView = ({ status, onSync }) => {
            const [url, setUrl] = useState(() => JSON.parse(localStorage.getItem('sistemp_cloud_config') || '{}').url || '');
            const [key, setKey] = useState(() => JSON.parse(localStorage.getItem('sistemp_cloud_config') || '{}').key || '');
            const save = () => { localStorage.setItem('sistemp_cloud_config', JSON.stringify({url, key})); onSync(); alert('Salvo!'); };

            return (
                <div className="max-w-2xl mx-auto bg-white p-12 rounded-[3rem] shadow-xl border border-slate-100">
                    <div className="flex items-center space-x-6 mb-10">
                        <div className={`p-5 rounded-3xl ${status === 'connected' ? 'bg-green-100 text-green-600' : 'bg-blue-100 text-blue-600'}`}><Database size={32} /></div>
                        <div>
                            <h2 className="text-2xl font-black">Nuvem & Sincronização</h2>
                            <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Acesso compartilhado para equipe</p>
                        </div>
                    </div>
                    <div className="space-y-6">
                        <input value={url} onChange={e=>setUrl(e.target.value)} placeholder="Supabase Project URL" className="w-full p-4 bg-slate-50 border rounded-2xl font-mono text-sm" />
                        <input value={key} onChange={e=>setKey(e.target.value)} type="password" placeholder="Supabase Anon Key" className="w-full p-4 bg-slate-50 border rounded-2xl font-mono text-sm" />
                        <button onClick={save} className="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black uppercase tracking-widest shadow-xl hover:bg-indigo-700 transition-all">Conectar Equipe</button>
                    </div>
                </div>
            );
        };

        const MainApp = () => {
            const [user, setUser] = useState(null);
            const [tab, setTab] = useState('dashboard');
            const [vacancies, setVacancies] = useState(() => JSON.parse(localStorage.getItem('sistemp_v') || JSON.stringify(INITIAL_VACANCIES)));
            const [status, setStatus] = useState('idle');
            const lastUpdate = useRef(null);

            const sync = useCallback(async () => {
                const cfg = JSON.parse(localStorage.getItem('sistemp_cloud_config') || '{}');
                if (!cfg.url) return;
                try {
                    const sb = createClient(cfg.url, cfg.key);
                    const { data } = await sb.from('sistemp_data').select('*').single();
                    if (data && data.updated_at !== lastUpdate.current) {
                        setVacancies(data.vacancies || []);
                        lastUpdate.current = data.updated_at;
                    }
                    setStatus('connected');
                } catch (e) { setStatus('error'); }
            }, []);

            useEffect(() => { sync(); }, [sync]);
            useEffect(() => { localStorage.setItem('sistemp_v', JSON.stringify(vacancies)); }, [vacancies]);

            if (!user) return <LoginView onLogin={setUser} />;

            return (
                <div className="flex h-screen overflow-hidden">
                    <aside className="w-72 bg-slate-900 text-white p-8 flex flex-col space-y-12">
                        <div className="flex items-center space-x-3"><ShieldCheck className="text-blue-500" size={36} /><span className="font-black text-3xl tracking-tighter">SisTemp</span></div>
                        <nav className="flex-1 space-y-3">
                            <button onClick={() => setTab('dashboard')} className={`w-full flex items-center p-4 rounded-2xl transition-all ${tab === 'dashboard' ? 'bg-blue-600 shadow-xl shadow-blue-900/40' : 'text-slate-400 hover:bg-slate-800'}`}><LayoutDashboard className="mr-3" /> <span className="font-bold">Painel</span></button>
                            <button onClick={() => setTab('vacancies')} className={`w-full flex items-center p-4 rounded-2xl transition-all ${tab === 'vacancies' ? 'bg-blue-600 shadow-xl shadow-blue-900/40' : 'text-slate-400 hover:bg-slate-800'}`}><Building2 className="mr-3" /> <span className="font-bold">Vagas</span></button>
                            <button onClick={() => setTab('settings')} className={`w-full flex items-center p-4 rounded-2xl transition-all ${tab === 'settings' ? 'bg-indigo-600 shadow-xl shadow-indigo-900/40' : 'text-slate-400 hover:bg-slate-800'}`}><Zap className="mr-3" /> <span className="font-bold">Nuvem</span></button>
                        </nav>
                        <button onClick={() => setUser(null)} className="flex items-center p-4 rounded-2xl text-red-400 hover:bg-red-400/10 font-bold transition-all"><LogOut className="mr-3" /> Sair</button>
                    </aside>
                    <main className="flex-1 overflow-y-auto custom-scrollbar">
                        <header className="bg-white/80 backdrop-blur-md border-b p-8 flex justify-between items-center sticky top-0 z-20">
                            <div className="flex items-center space-x-4">
                                <h2 className="text-2xl font-black text-slate-800 uppercase tracking-tight">{tab}</h2>
                                {status === 'connected' && (
                                    <div className="flex items-center bg-green-50 text-green-600 px-5 py-2 rounded-full border border-green-200">
                                        <div className="pulse-ring mr-3"><Zap size={14} className="fill-green-600" /></div>
                                        <span className="text-[10px] font-black uppercase tracking-widest">Ao Vivo</span>
                                    </div>
                                )}
                            </div>
                            <div className="text-xs font-bold text-slate-400 uppercase tracking-widest">Data: {new Date().toLocaleDateString('pt-BR')}</div>
                        </header>
                        <div className="p-12 max-w-6xl mx-auto">
                            {tab === 'dashboard' ? <Dashboard vacancies={vacancies} /> : 
                             tab === 'settings' ? <SettingsView status={status} onSync={sync} /> :
                             <div className="text-center py-20 text-slate-300 italic">Módulo em carregamento...</div>}
                        </div>
                    </main>
                </div>
            );
        };

        createRoot(document.getElementById('root')).render(<MainApp />);
    </script>
</body>
</html>
